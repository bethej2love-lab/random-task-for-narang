<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Ìï† Ïùº ÎûúÎç§ ÎΩëÍ∏∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --accent: #4b8cff;
      --accent-soft: #8faefc;
      --accent-bg: #f4f4f4;
      --card-bg: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding-top: 40px;
      background: var(--accent-bg, #f4f4f4);
      transition: background 0.3s ease;
    }
    .card {
      background: var(--card-bg, #ffffff);
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      text-align: center;
      max-width: 420px;
      width: 100%;
      box-sizing: border-box;
      transition: background 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .theme-label {
      font-size: 18px;
      margin-bottom: 20px;
    }
    #result {
      font-size: 22px;
      font-weight: 700;
      margin: 20px 0 8px;
      min-height: 32px;
    }
    #hint {
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
      min-height: 16px;
    }
    button.main {
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      background: var(--accent, #4b8cff);
      color: white;
      font-weight: 600;
      width: 100%;
      transition: transform 0.05s ease, opacity 0.1s ease, background 0.2s ease, box-shadow 0.1s ease;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    }
    button.main:active {
      transform: scale(0.97);
      opacity: 0.9;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.16);
    }
    button.main:disabled {
      opacity: 0.6;
      cursor: default;
      background: var(--accent-soft, #8faefc);
      box-shadow: none;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    .action-buttons button {
      flex: 1;
      padding: 10px 0;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .complete-btn {
      background: #2ecc71;
      color: white;
    }
    .pending-btn {
      background: #e0e0e0;
      color: #333;
    }
    .progress-box {
      margin-top: 20px;
      text-align: left;
      font-size: 14px;
    }
    .status-summary {
      font-size: 13px;
      margin-bottom: 6px;
      text-align: right;
      color: #444;
    }
    .progress-bar {
      margin-top: 4px;
      font-size: 18px;
      letter-spacing: 2px;
      text-align: center;
    }
    .checkbox-list {
      margin-top: 12px;
      font-size: 14px;
    }
    .checkbox-list div {
      margin-bottom: 6px;
    }
    .streak-box {
      margin-top: 16px;
      font-size: 13px;
    }
    .streak-bar {
      margin-top: 4px;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e0e0e0;
      overflow: hidden;
    }
    .streak-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent, #4b8cff), #2ecc71);
      transition: width 0.3s ease;
    }
    #eventText {
      margin-top: 10px;
      font-size: 12px;
      color: #555;
    }
    .s-glow {
      color: #e67e22;
      text-shadow: 0 0 6px rgba(255, 215, 0, 0.9);
      animation: sPulse 0.8s ease-in-out 2;
    }
    @keyframes sPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }
    .tier-label {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      color: #999;
      border: 1px solid #ddd;
      padding: 2px 6px;
      border-radius: 999px;
      margin-right: 6px;
      vertical-align: middle;
    }

    /* Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ Î™®Îã¨ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 18px 16px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      font-size: 13px;
      box-sizing: border-box;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }
    .weekly-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .weekly-label {
      color: #555;
    }
    .weekly-bar {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      letter-spacing: 1px;
    }
    .modal-close-btn {
      margin-top: 10px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 8px 0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent, #4b8cff);
      color: #fff;
    }

    /* Îã¨Î†• Ïä§ÌÉÄÏùº */
    #toggleCalendarButton {
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #ffffff;
      cursor: pointer;
    }
    #calendarContainer {
      margin-top: 10px;
      font-size: 11px;
    }
    .calendar-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      text-align: center;
    }
    .calendar-table {
      width: 100%;
      border-collapse: collapse;
    }
    .calendar-table th,
    .calendar-table td {
      border: 1px solid #eee;
      text-align: center;
      padding: 4px 2px;
      vertical-align: top;
      min-width: 32px;
    }
    .calendar-table th {
      background: #f8f8f8;
      font-weight: 600;
    }
    .cal-day-number {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .cal-day-tasks {
      color: #555;
    }
    .cal-today {
      background: rgba(75, 140, 255, 0.15);
    }

    /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
    @media (max-width: 480px) {
      body {
        padding-top: 24px;
      }
      .card {
        padding: 20px 18px;
        border-radius: 14px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
      }
      h1 {
        font-size: 18px;
      }
      #result {
        font-size: 20px;
      }
      button.main {
        font-size: 15px;
        padding: 12px 16px;
      }
      .checkbox-list {
        font-size: 13px;
      }
      .modal-overlay {
        align-items: flex-end;
      }
      .modal-content {
        max-width: 480px;
        width: 100%;
        border-radius: 16px 16px 0 0;
      }
      .calendar-table th,
      .calendar-table td {
        padding: 3px 1px;
      }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>Ìï† Ïùº ÎûúÎç§ ÎΩëÍ∏∞</h1>
    <div class="theme-label" id="themeLabel"></div>

    <button class="main" id="pickButton" onclick="pickRandom()">ÏßÄÍ∏à ÎãπÏû• Ïù¥Í±∞!</button>

    <div id="result">Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏãúÏûë!</div>
    <div id="hint"></div>

    <div class="action-buttons" style="display:none;" id="actionButtons">
      <button class="complete-btn" onclick="markComplete()">ÏôÑÎ£å</button>
      <button class="pending-btn" onclick="hideButtons()">Î≥¥Î•ò</button>
    </div>

    <!-- ÏßÑÌñâÎèÑ + Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ + Ïó∞Í∞Ñ ÌçºÏÑºÌä∏ (Ï≤´ ÌôîÎ©¥ÏóêÏÑúÎäî Ïïà Î≥¥ÏûÑ) -->
    <div class="progress-box" id="progressContainer" style="display:none;">
      <div class="status-summary" id="statusSummary">ÏΩîÏù∏: 0Í∞ú ¬∑ LV 1</div>

      <div id="progressText">Ïò§Îäò ÏôÑÎ£å: 0 / 7</div>
      <div class="progress-bar" id="progressBar">‚óã‚óã‚óã‚óã‚óã‚óã‚óã‚óã‚óã‚óã</div>
      <div class="checkbox-list" id="checkboxList"></div>

      <div class="streak-box">
        <div id="streakText">Ïò¨Ìï¥ Ï†ÑÎ∂Ä Îã§ Ìïú ÎÇ†: 0Ïùº / 365Ïùº (0.0%)</div>
        <div class="streak-bar">
          <div class="streak-fill" id="streakFill"></div>
        </div>
      </div>

      <div id="eventText"></div>

      <!-- Ïù¥Î≤à Îã¨ Îã¨Î†• ÌÜ†Í∏Ä Î≤ÑÌäº + Ïª®ÌÖåÏù¥ÎÑà -->
      <button id="toggleCalendarButton" onclick="toggleCalendar()">Ïù¥Î≤à Îã¨ Îã¨Î†• Î≥¥Í∏∞</button>
      <div id="calendarContainer" style="display:none;"></div>
    </div>
  </div>

  <!-- ÏµúÍ∑º 7Ïùº ÌÜµÍ≥Ñ Î™®Îã¨ -->
  <div class="modal-overlay" id="weeklyModal">
    <div class="modal-content">
      <div class="modal-title">ÏµúÍ∑º 7Ïùº ÏôÑÎ£å ÌòÑÌô©</div>
      <div id="weeklyStatsBody"></div>
      <button class="modal-close-btn" onclick="closeWeeklyStats()">ÌôïÏù∏</button>
    </div>
  </div>

  <script>
    const tasks = [
      "ÎìÄÏò§ÎßÅÍ≥†",
      "Brilliant",
      "Ï±Ö ÏùΩÍ∏∞",
      "ÌîåÎû≠ÌÅ¨ 1Î∂Ñ+Í∞ÑÎã® Ïä§Ìä∏Î†àÏπ≠",
      "Î∂ÄÍ∏∞Ïä§/Î∏îÎ°úÍ∑∏",
      "Îã¨Î¶¨Í∏∞",
      "CBT Î¨∏Ï†ú ÌíÄÍ∏∞"
    ];

    const hints = {
      "ÎìÄÏò§ÎßÅÍ≥†": "‚Üí ÏòÅÏñ¥ Î†àÏä® ÏôÑÏ£ºÎ•º Ìñ•Ìï¥",
      "Brilliant": "‚Üí 3Í∞ú Ïù¥ÏÉÅ Ìë∏Ïã≠Ïáº",
      "Ï±Ö ÏùΩÍ∏∞": "‚Üí Ìïú ÌéòÏù¥ÏßÄÎùºÎèÑ...",
      "ÌîåÎû≠ÌÅ¨ 1Î∂Ñ+Í∞ÑÎã® Ïä§Ìä∏Î†àÏπ≠": "‚Üí Î™∏ÏùÑ ÏõÄÏßÅÏó¨Îùº!",
      "Î∂ÄÍ∏∞Ïä§/Î∏îÎ°úÍ∑∏": "‚Üí Ï±Ö Îì±Î°ù/Î∏îÎ°úÍ∑∏ ÏóÖÎ°úÎìú/Ïù∏Ïä§ÌÉÄ ÏóÖÎ°úÎìú/Î¶¨Î∑∞ ÎãµÍ∏Ä Î≠êÎì† Ï†úÎ∞ú!",
      "Îã¨Î¶¨Í∏∞": "‚Üí 5Î∂ÑÏù¥ÎùºÎèÑ! (ÎßåÎ≥¥ ÎåÄÏ≤¥ Í∞ÄÎä•„Öé)",
      "CBT Î¨∏Ï†ú ÌíÄÍ∏∞": "‚Üí ÏûêÍ≤©Ï¶ù Îî∞ÏïºÏ†ú.."
    };

    // Îì±Í∏â ÏÑ§Ï†ï
    const taskTier = {
      "Îã¨Î¶¨Í∏∞": "S",
      "Î∂ÄÍ∏∞Ïä§/Î∏îÎ°úÍ∑∏": "S",
      "Ï±Ö ÏùΩÍ∏∞": "A",
      "CBT Î¨∏Ï†ú ÌíÄÍ∏∞": "A",
      "Brilliant": "B",
      "ÌîåÎû≠ÌÅ¨ 1Î∂Ñ+Í∞ÑÎã® Ïä§Ìä∏Î†àÏπ≠": "B",
      "ÎìÄÏò§ÎßÅÍ≥†": "B"
    };

    const tierLabel = {
      "S": "SÍ∏â",
      "A": "AÍ∏â",
      "B": "BÍ∏â"
    };

    // ÏΩîÏù∏ Í∏∞Î≥∏ Î≥¥ÏÉÅ
    const baseReward = {
      "S": 3,
      "A": 2,
      "B": 1,
      "BONUS": 0
    };

    // ÌïúÍµ≠ Í∏∞Ï§Ä ÎÇ†Ïßú Î¨∏ÏûêÏó¥ (YYYY-MM-DD)
    function getKSTDate() {
      const now = new Date();
      const offsetKST = 9 * 60 * 60 * 1000; // ÌïúÍµ≠ UTC+9
      const kst = new Date(now.getTime() + offsetKST - (now.getTimezoneOffset() * 60 * 1000));
      return kst.toISOString().slice(0, 10);
    }

    const today = getKSTDate();

    // ÎûúÎç§ Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ Î™©Î°ù
    const dailyEvents = [
      {
        id: "buff_all_plus1",
        label: "Ïò§ÎäòÏùò Î≤ÑÌîÑ: Î™®Îì† ÎØ∏ÏÖò ÏΩîÏù∏ +1!",
        type: "buff"
      },
      {
        id: "buff_s_plus1",
        label: "Ïò§ÎäòÏùò Î≤ÑÌîÑ: SÍ∏â ÎØ∏ÏÖò ÏΩîÏù∏ +1!",
        type: "buff"
      },
      {
        id: "nerf_s_minus1",
        label: "Ïò§ÎäòÏùò ÎîîÎ≤ÑÌîÑ: SÍ∏â ÎØ∏ÏÖò ÏΩîÏù∏ -1‚Ä¶",
        type: "debuff"
      },
      {
        id: "half_day_full",
        label: "Ïò§ÎäòÏùò ÌäπÏàò: 4Í∞úÎßå ÏôÑÎ£åÌï¥ÎèÑ 'ÏôÑÎ£åÌïú ÎÇ†'Î°ú Ïù∏Ï†ï!",
        type: "special"
      }
    ];

    function loadTaskStatus() {
      const stored = JSON.parse(localStorage.getItem("taskStatus"));
      const storedDate = localStorage.getItem("taskDate");

      if (!stored || storedDate !== today) {
        const reset = {};
        tasks.forEach(t => reset[t] = false);
        localStorage.setItem("taskStatus", JSON.stringify(reset));
        localStorage.setItem("taskDate", today);
        return reset;
      }
      return stored;
    }

    function loadFullDays() {
      const count = parseInt(localStorage.getItem("fullCompleteCount") || "0", 10);
      const lastDate = localStorage.getItem("fullCompleteDate") || "";
      return { count, lastDate };
    }

    function loadCoins() {
      return parseInt(localStorage.getItem("coinCount") || "0", 10);
    }

    function loadDailyEvent() {
      const storedId = localStorage.getItem("dailyEventId");
      const storedDate = localStorage.getItem("dailyEventDate");

      if (!storedId || storedDate !== today) {
        const event = dailyEvents[Math.floor(Math.random() * dailyEvents.length)];
        localStorage.setItem("dailyEventId", event.id);
        localStorage.setItem("dailyEventDate", today);
        return event;
      } else {
        const found = dailyEvents.find(e => e.id === storedId);
        return found || dailyEvents[0];
      }
    }

    // ÎÇ†ÏßúÎ≥Ñ ÏôÑÎ£å Í∞úÏàò Ï†ÄÏû•Ïö©
    function loadDailyStats() {
      const raw = localStorage.getItem("dailyStats");
      if (!raw) return {};
      try {
        return JSON.parse(raw);
      } catch (e) {
        return {};
      }
    }

    function saveDailyStats(stats) {
      localStorage.setItem("dailyStats", JSON.stringify(stats));
    }

    // 2/4/6Í∞ú Îã¨ÏÑ± Ïãú ÌåùÏóÖ Ïó¨Î∂Ä Ï†ÄÏû•
    function loadWeeklyPopupStatus() {
      const raw = localStorage.getItem("weeklyPopupStatus");
      if (!raw) return {};
      try {
        return JSON.parse(raw);
      } catch (e) {
        return {};
      }
    }

    function saveWeeklyPopupStatus(status) {
      localStorage.setItem("weeklyPopupStatus", JSON.stringify(status));
    }

    let taskStatus = loadTaskStatus();
    let { count: fullCompleteCount, lastDate: fullCompleteDate } = loadFullDays();
    let coinCount = loadCoins();
    let dailyEvent = loadDailyEvent();
    let isPicking = false;
    let hasShownProgress = false;
    let currentTask = null;
    let currentTier = null;

    function getLevel(percent) {
      // 0% -> LV 1, 100% -> LV 10
      const lvl = Math.floor(percent / 10) + 1;
      return Math.min(10, Math.max(1, lvl));
    }

    function getRewardForTask(taskName) {
      const tier = taskTier[taskName] || "B";
      let reward = baseReward[tier];

      // Î≥¥ÎÑàÏä§Îäî Í∏∞Î≥∏ 0, Ïù¥Î≤§Ìä∏ ÏòÅÌñ•ÎèÑ Î∞õÏßÄ ÏïäÍ≤å Ïú†ÏßÄ
      if (tier === "BONUS") return 0;

      if (dailyEvent.id === "buff_all_plus1" && reward > 0) {
        reward += 1;
      }
      if (dailyEvent.id === "buff_s_plus1" && tier === "S") {
        reward += 1;
      }
      if (dailyEvent.id === "nerf_s_minus1" && tier === "S") {
        reward = Math.max(0, reward - 1);
      }

      return reward;
    }

    function updateUI() {
      const completed = Object.values(taskStatus).filter(v => v).length;

      // Ïò§ÎäòÏùÑ "ÏôÑÎ£åÌïú ÎÇ†"Î°ú Ïù∏Ï†ïÌïòÎäî Í∏∞Ï§Ä
      let fullNeeded = tasks.length;
      if (dailyEvent.id === "half_day_full") {
        fullNeeded = Math.ceil(tasks.length / 2); // 4Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ ÌïòÎ£® Ïù∏Ï†ï
      }

      if (completed >= fullNeeded && fullCompleteDate !== today) {
        fullCompleteCount += 1;
        fullCompleteDate = today;
        localStorage.setItem("fullCompleteCount", String(fullCompleteCount));
        localStorage.setItem("fullCompleteDate", fullCompleteDate);
      }

      // Ïò§Îäò ÏôÑÎ£å Í∞úÏàò -> ÏùºÎ≥Ñ ÌÜµÍ≥ÑÏóê Ï†ÄÏû•
      const stats = loadDailyStats();
      stats[today] = completed;
      saveDailyStats(stats);

      // Ïò§Îäò ÏßÑÌñâÎèÑ
      document.getElementById("progressText").textContent =
        `Ïò§Îäò ÏôÑÎ£å: ${completed} / ${tasks.length}`;

      const circle = "‚óè".repeat(completed) + "‚óã".repeat(tasks.length - completed);
      document.getElementById("progressBar").textContent = circle;

      const listEl = document.getElementById("checkboxList");
      listEl.innerHTML = "";
      tasks.forEach(t => {
        const div = document.createElement("div");
        div.textContent = (taskStatus[t] ? "‚úî " : "‚ñ° ") + t;
        listEl.appendChild(div);
      });

      // Ïó∞Í∞Ñ ÌçºÏÑºÌä∏ + Î†àÎ≤®
      const percent = Math.min(100, (fullCompleteCount / 365) * 100);
      const level = getLevel(percent);

      document.getElementById("streakText").textContent =
        `Ïò¨Ìï¥ Ï†ÑÎ∂Ä Îã§ Ìïú ÎÇ†: ${fullCompleteCount}Ïùº / 365Ïùº (${percent.toFixed(1)}%)`;
      document.getElementById("streakFill").style.width = `${percent}%`;

      // ÏΩîÏù∏ + Î†àÎ≤® ÌëúÏãú
      document.getElementById("statusSummary").textContent =
        `ÏΩîÏù∏: ${coinCount}Í∞ú ¬∑ LV ${level}`;

      // Ïò§ÎäòÏùò Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÌëúÏãú
      document.getElementById("eventText").textContent = dailyEvent.label;
    }

    function showProgressIfNeeded() {
      if (!hasShownProgress) {
        document.getElementById("progressContainer").style.display = "block";
        hasShownProgress = true;
      }
    }

    // 10Í∞ÄÏßÄ ÏùºÏùº ÌÖåÎßà (KST Í∏∞Ï§Ä ÎÇ†ÏßúÎ°ú Îß§Ïùº Î≥ÄÍ≤Ω)
    function applyTheme() {
      const kstStr = getKSTDate();
      const [y, m, d] = kstStr.split("-").map(Number);
      const date = new Date(y, m - 1, d);
      const yearStart = new Date(date.getFullYear(), 0, 1);
      const diffDays = Math.floor((date - yearStart) / 86400000);

      const themes = [
        { emoji: "üåÖ", bodyBg: "#fff5e6", cardBg: "#ffffff", accent: "#ff7b54", accentSoft: "#ffb199" },
        { emoji: "üåä", bodyBg: "#e6f5ff", cardBg: "#ffffff", accent: "#3f8cff", accentSoft: "#9ac3ff" },
        { emoji: "üåø", bodyBg: "#eef8f2", cardBg: "#ffffff", accent: "#2ecc71", accentSoft: "#8be3aa" },
        { emoji: "üåå", bodyBg: "#050816", cardBg: "#111827", accent: "#6366f1", accentSoft: "#a5b4fc" },
        { emoji: "‚òïÔ∏è", bodyBg: "#f7f0ea", cardBg: "#ffffff", accent: "#b85c38", accentSoft: "#d19d85" },
        { emoji: "üìö", bodyBg: "#f6f4ff", cardBg: "#ffffff", accent: "#7c3aed", accentSoft: "#c4b5fd" },
        { emoji: "üî•", bodyBg: "#fff1f2", cardBg: "#ffffff", accent: "#f97373", accentSoft: "#fecaca" },
        { emoji: "üåà", bodyBg: "linear-gradient(135deg,#fdf2ff,#e0f2fe)", cardBg: "#ffffff", accent: "#ec4899", accentSoft: "#f9a8d4" },
        { emoji: "üßä", bodyBg: "#edf5ff", cardBg: "#ffffff", accent: "#0ea5e9", accentSoft: "#7dd3fc" },
        { emoji: "üçÄ", bodyBg: "#f1fdf3", cardBg: "#ffffff", accent: "#16a34a", accentSoft: "#6ee7b7" }
      ];

      const theme = themes[diffDays % themes.length];

      document.getElementById("themeLabel").textContent = theme.emoji;

      document.body.style.setProperty("--accent-bg", theme.bodyBg);
      document.documentElement.style.setProperty("--accent", theme.accent);
      document.documentElement.style.setProperty("--accent-soft", theme.accentSoft);

      document.body.style.background = theme.bodyBg;
      const card = document.getElementById("card");
      if (card) {
        card.style.background = theme.cardBg;
      }
    }

    applyTheme();
    updateUI(); // Îç∞Ïù¥ÌÑ∞Îäî ÎØ∏Î¶¨ Ï§ÄÎπÑÌï¥ÎëêÍ≥†, ÌôîÎ©¥ÏùÄ Ï≤´ Í≤∞Í≥º Ïù¥ÌõÑÏóêÎßå ÌëúÏãúÎê®

    // ÏµúÍ∑º 7Ïùº Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
    function buildLast7DaysData() {
      const stats = loadDailyStats();
      const [y, m, d] = today.split("-").map(Number);
      const base = new Date(y, m - 1, d);
      const result = [];

      for (let i = 6; i >= 0; i--) {
        const dt = new Date(base);
        dt.setDate(base.getDate() - i);
        const yy = dt.getFullYear();
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const dd = String(dt.getDate()).padStart(2, "0");
        const key = `${yy}-${mm}-${dd}`;
        const cnt = stats[key] || 0;
        result.push({
          key,
          label: `${mm}/${dd}`,
          count: cnt
        });
      }
      return result;
    }

    function openWeeklyStatsModal() {
      const data = buildLast7DaysData();
      const body = document.getElementById("weeklyStatsBody");
      body.innerHTML = "";

      data.forEach(item => {
        const row = document.createElement("div");
        row.className = "weekly-row";

        const label = document.createElement("div");
        label.className = "weekly-label";
        label.textContent = item.label;

        const bar = document.createElement("div");
        bar.className = "weekly-bar";
        const filled = "‚óè".repeat(item.count);
        const empty = "‚óã".repeat(tasks.length - item.count);
        bar.textContent = `${filled}${empty} (${item.count}/${tasks.length})`;

        row.appendChild(label);
        row.appendChild(bar);
        body.appendChild(row);
      });

      const modal = document.getElementById("weeklyModal");
      modal.style.display = "flex";
    }

    function closeWeeklyStats() {
      const modal = document.getElementById("weeklyModal");
      modal.style.display = "none";
    }

    // 2/4/6Í∞ú ÏôÑÎ£å Ïãú Ï£ºÍ∞Ñ Í∑∏ÎûòÌîÑ ÏûêÎèô ÌåùÏóÖ
    function checkAndShowWeeklyStats() {
      const completed = Object.values(taskStatus).filter(v => v).length;
      const thresholds = [2, 4, 6];

      if (!thresholds.includes(completed)) return;

      const status = loadWeeklyPopupStatus();
      const todayStatus = status[today] || {};

      // Ïù¥ÎØ∏ Ïù¥ Í∞úÏàòÏóêÏÑú Ìïú Î≤à ÌåùÏóÖÌñàÏúºÎ©¥ Ïä§ÌÇµ
      if (todayStatus[completed]) return;

      // Í∏∞Î°ù ÎÇ®Í∏∞Í≥† ÌåùÏóÖ
      todayStatus[completed] = true;
      status[today] = todayStatus;
      saveWeeklyPopupStatus(status);

      openWeeklyStatsModal();
    }

    // Îã¨Î†• ÏÉùÏÑ±
    function buildMonthlyCalendar() {
      const stats = loadDailyStats();
      const [y, m, _d] = today.split("-").map(Number);
      const year = y;
      const month = m; // 1~12

      const firstDay = new Date(year, month - 1, 1).getDay(); // 0(Ïùº)~6(ÌÜ†)
      const lastDate = new Date(year, month, 0).getDate();

      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";

      const title = document.createElement("div");
      title.className = "calendar-title";
      title.textContent = `${year}ÎÖÑ ${month}Ïõî`;
      container.appendChild(title);

      const table = document.createElement("table");
      table.className = "calendar-table";

      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      const weekdays = ["Ïùº", "Ïõî", "Ìôî", "Ïàò", "Î™©", "Í∏à", "ÌÜ†"];
      weekdays.forEach(w => {
        const th = document.createElement("th");
        th.textContent = w;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      let row = document.createElement("tr");
      let cellCount = 0;

      // Ïïû Í≥µÎ∞± ÏÖÄ
      for (let i = 0; i < firstDay; i++) {
        const td = document.createElement("td");
        row.appendChild(td);
        cellCount++;
      }

      for (let day = 1; day <= lastDate; day++) {
        if (cellCount === 7) {
          tbody.appendChild(row);
          row = document.createElement("tr");
          cellCount = 0;
        }

        const td = document.createElement("td");
        const dd = String(day).padStart(2, "0");
        const mm = String(month).padStart(2, "0");
        const key = `${year}-${mm}-${dd}`;
        const cnt = stats[key] || 0;

        const num = document.createElement("div");
        num.className = "cal-day-number";
        num.textContent = day;

        const info = document.createElement("div");
        info.className = "cal-day-tasks";
        info.textContent = `${cnt}/${tasks.length}`;

        td.appendChild(num);
        td.appendChild(info);

        // Ïò§Îäò Í∞ïÏ°∞
        if (key === today) {
          td.classList.add("cal-today");
        }

        row.appendChild(td);
        cellCount++;
      }

      // ÎßàÏßÄÎßâ Ï§Ñ ÎÇ®ÏùÄ ÏÖÄ Í≥µÎ∞± Ï≤òÎ¶¨
      if (cellCount > 0 && cellCount < 7) {
        for (let i = cellCount; i < 7; i++) {
          const td = document.createElement("td");
          row.appendChild(td);
        }
        tbody.appendChild(row);
      } else if (cellCount === 7) {
        tbody.appendChild(row);
      }

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function toggleCalendar() {
      const container = document.getElementById("calendarContainer");
      const btn = document.getElementById("toggleCalendarButton");

      if (container.style.display === "none" || !container.style.display) {
        buildMonthlyCalendar();
        container.style.display = "block";
        btn.textContent = "Îã¨Î†• Îã´Í∏∞";
      } else {
        container.style.display = "none";
        btn.textContent = "Ïù¥Î≤à Îã¨ Îã¨Î†• Î≥¥Í∏∞";
      }
    }

    function pickRandom() {
      if (isPicking) return;
      isPicking = true;

      const pickBtn = document.getElementById("pickButton");
      const resultEl = document.getElementById("result");
      const hintEl = document.getElementById("hint");

      pickBtn.disabled = true;
      pickBtn.textContent = "Í≥†Î•¥Îäî Ï§ë...";

      document.getElementById("actionButtons").style.display = "none";
      resultEl.classList.remove("s-glow");

      const available = tasks.filter(t => !taskStatus[t]);

      if (available.length === 0) {
        resultEl.textContent = "Ïò§Îäò Ìï† Ïùº ÏôÑÎ£å!";
        hintEl.textContent = "";
        pickBtn.disabled = false;
        pickBtn.textContent = "ÏßÄÍ∏à ÎãπÏû• Ïù¥Í±∞!";
        isPicking = false;
        showProgressIfNeeded();
        return;
      }

      // Í≥†ÎØº Ï§ë... Ïï†ÎãàÎ©îÏù¥ÏÖò
      let dots = 0;
      resultEl.textContent = "Í≥†ÎØº Ï§ë";
      hintEl.textContent = "2Ï¥àÎßå Í∏∞Îã§Î†§Ï§ò‚Ä¶";
      const loading = setInterval(() => {
        dots = (dots + 1) % 4;
        resultEl.textContent = "Í≥†ÎØº Ï§ë" + ".".repeat(dots);
      }, 400);

      setTimeout(() => {
        clearInterval(loading);

        const finalChoice = available[Math.floor(Math.random() * available.length)];
        const finalTier = taskTier[finalChoice] || "B";

        currentTask = finalChoice;
        currentTier = finalTier;

        const label = tierLabel[finalTier] || "BÍ∏â";
        const badge = `<span class="tier-label">${label}</span>`;
        const safeText = finalChoice.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        resultEl.innerHTML = `${badge}${safeText}`;

        const baseHint = hints[finalChoice] || "";
        if (finalTier === "S") {
          resultEl.classList.add("s-glow");
          hintEl.textContent = `‚ú® SÍ∏â ÎØ∏ÏÖò Îì±Ïû•! ‚ú® ${baseHint}`;
        } else {
          hintEl.textContent = baseHint;
        }

        document.getElementById("actionButtons").style.display = "flex";

        pickBtn.disabled = false;
        pickBtn.textContent = "ÏßÄÍ∏à ÎãπÏû• Ïù¥Í±∞!";
        isPicking = false;

        showProgressIfNeeded();
      }, 2000);
    }

    function markComplete() {
      if (!currentTask || !tasks.includes(currentTask)) return;

      if (taskStatus[currentTask]) {
        document.getElementById("hint").textContent = "Ïù¥ÎØ∏ ÏôÑÎ£åÌïú ÎØ∏ÏÖòÏù¥ÏóêÏöî!";
        hideButtons();
        return;
      }

      taskStatus[currentTask] = true;
      localStorage.setItem("taskStatus", JSON.stringify(taskStatus));

      const reward = getRewardForTask(currentTask);
      if (reward > 0) {
        coinCount += reward;
        localStorage.setItem("coinCount", String(coinCount));
        document.getElementById("hint").textContent =
          `ÏôÑÎ£å Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§! (+${reward}ÏΩîÏù∏)`;
      } else {
        document.getElementById("hint").textContent =
          "ÏôÑÎ£å Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§!";
      }

      hideButtons();
      updateUI();
      checkAndShowWeeklyStats();
    }

    function hideButtons() {
      document.getElementById("actionButtons").style.display = "none";
    }
  </script>
</body>
</html>
